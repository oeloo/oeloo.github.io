<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glycemia Chart Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        .container {
            display: flex;
            width: 100%;
            justify-content: space-between;
            gap: 20px;
        }
        #input-container {
            width: 30%;
        }
        textarea {
            width: 100%;
            height: 300px;
            font-size: 14px;
        }
        .threshold-inputs {
            margin-top: 10px;
        }
        .threshold-inputs label {
            display: block;
            margin-top: 5px;
        }
        #chart-container {
            width: 65%;
            height: 500px;
            border: 1px solid #ddd;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>Glycemia Chart Generator</h2>
    
    <div class="container">
        <!-- Input Section -->
        <div id="input-container">
            <h3>Enter Glycemia Data</h3>
            <textarea id="data-input" placeholder="Paste your data here...
Format: 8h : 2,95 g/L"></textarea><br>
            
            <div class="threshold-inputs">
                <label for="threshold-min">Minimum Threshold (g/L):</label>
                <input type="number" id="threshold-min" value="1.0" step="0.1">
                
                <label for="threshold-max">Maximum Threshold (g/L):</label>
                <input type="number" id="threshold-max" value="2.0" step="0.1">
            </div>
            
            <button onclick="generateChart()">Generate Chart</button>
        </div>

        <!-- Chart Section -->
        <div id="chart-container">
            <canvas id="glycemiaChart"></canvas>
        </div>
    </div>

    <script>
        // Function to parse input data
        function parseData(input) {
            const lines = input.trim().split("\n"); // Split each line and remove spaces
            const hours = [];
            const values = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                // Regex to extract hour and value
                const match = line.match(/(\d+h)\s*:\s*([\d,]+)/);
                
                if (match) {
                    hours.push(match[1]); // Extract hour
                    // Convert value to float (replace comma with dot)
                    const value = parseFloat(match[2].replace(",", "."));
                    values.push(value);
                    console.log(`Line ${i+1}: ${match[1]} = ${value}`);
                } else {
                    console.log(`Line ${i+1} not recognized: ${line}`);
                }
            }

            console.log("Hours:", hours);
            console.log("Values:", values);
            return { hours, values };
        }

        // Function to generate the chart
        function generateChart() {
            const input = document.getElementById("data-input").value; // Get input data
            
            if (!input.trim()) {
                alert("Please enter data");
                return;
            }
            
            const { hours, values } = parseData(input);

            // Check if valid data was extracted
            if (hours.length === 0 || values.length === 0) {
                alert("No valid data found. Please enter data in the format: '8h : 2,95 g/L'");
                return;
            }

            // Get threshold values from inputs
            const thresholdMinValue = parseFloat(document.getElementById("threshold-min").value);
            const thresholdMaxValue = parseFloat(document.getElementById("threshold-max").value);
            
            // Create arrays with threshold values
            const thresholdMin = Array(hours.length).fill(thresholdMinValue);
            const thresholdMax = Array(hours.length).fill(thresholdMaxValue);

            // Destroy previous chart if it exists
            if (window.glycemiaChart instanceof Chart) {
                window.glycemiaChart.destroy();
            }

            // Create the chart
            const ctx = document.getElementById("glycemiaChart").getContext("2d");
            window.glycemiaChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: "Glycemia (g/L)",
                            data: values,
                            borderColor: "blue",
                            backgroundColor: "rgba(0, 0, 255, 0.1)",
                            fill: false,
                            tension: 0.4,
                            pointStyle: "circle",
                            pointRadius: 5,
                        },
                        {
                            label: "Minimum Threshold",
                            data: thresholdMin,
                            borderColor: "orange",
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                        },
                        {
                            label: "Maximum Threshold",
                            data: thresholdMax,
                            borderColor: "red",
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: "top" },
                        title: {
                            display: true,
                            text: 'Glycemia Chart'
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: false,
                            min: 0,
                            max: Math.max(...values) + 0.5,
                            title: {
                                display: true,
                                text: 'Glycemia (g/L)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour'
                            }
                        }
                    },
                },
            });
            
            console.log("Chart successfully generated");
        }
        
        // Pre-fill with example data for testing
        window.onload = function() {
            document.getElementById("data-input").value = 
`8h : 2,95 g/L
9h : 2,91 g/L
10h : 1,67 g/L
11h : 1,4 g/L
12h : 1,17 g/L
13h : 0,78 g/L
14h : 0,8 g/L
15h : 2,33 g/L
16h : 2,05 g/L
17h : 2,21 g/L
18h : 2,37 g/L
19h : 2,74 g/L
20h : 2,87 g/L`;
        };
    </script>
</body>
</html>
