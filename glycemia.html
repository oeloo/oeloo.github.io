<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glycemia Chart Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        .container {
            display: flex;
            width: 100%;
            justify-content: space-between;
            gap: 20px;
        }
        #input-container {
            width: 20%;
        }
        textarea {
            width: 100%;
            height: 300px;
            font-size: 14px;
        }
        #chart-container {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>Générateur de Courbe de Glycémie</h2>
    
    <div class="container">
        <!-- Input Section -->
        <div id="input-container">
            <h3>Entrez les données de glycémie</h3>
            <textarea id="data-input" placeholder="Collez vos données ici...
Format: 8h : 2,95 g/L"></textarea><br>
            <button onclick="generateChart()">Générer la courbe</button>
        </div>

        <!-- Chart Section -->
        <div id="chart-container">
            <canvas id="glycemiaChart"></canvas>
        </div>
    </div>

    <script>
        // Fonction pour analyser les données d'entrée
        function parseData(input) {
            const lines = input.trim().split("\n"); // Séparer chaque ligne et supprimer les espaces
            const hours = [];
            const values = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                // Regex simplifiée pour extraire l'heure et la valeur
                const match = line.match(/(\d+h)\s*:\s*([\d,]+)/);
                
                if (match) {
                    hours.push(match[1]); // Extraire l'heure
                    // Convertir la valeur en float (remplacer la virgule par un point)
                    const value = parseFloat(match[2].replace(",", "."));
                    values.push(value);
                    console.log(`Ligne ${i+1}: ${match[1]} = ${value}`);
                } else {
                    console.log(`Ligne ${i+1} non reconnue: ${line}`);
                }
            }

            console.log("Heures:", hours);
            console.log("Valeurs:", values);
            return { hours, values };
        }

        // Fonction pour générer la courbe
        function generateChart() {
            const input = document.getElementById("data-input").value; // Récupérer les données saisies
            
            if (!input.trim()) {
                alert("Veuillez entrer des données");
                return;
            }
            
            const { hours, values } = parseData(input);

            // Vérifier si des données valides ont été extraites
            if (hours.length === 0 || values.length === 0) {
                alert("Aucune donnée valide trouvée. Veuillez entrer des données au format : '8h : 2,95 g/L'");
                return;
            }

            // Seuils
            const thresholdMin = Array(hours.length).fill(0.8); // Seuil minimum (1 g/L)
            const thresholdMax = Array(hours.length).fill(2.7); // Seuil maximum (2 g/L)

            // Détruire l'ancien graphique s'il existe
            if (window.glycemiaChart instanceof Chart) {
                window.glycemiaChart.destroy();
            }

            // Créer le graphique
            const ctx = document.getElementById("glycemiaChart").getContext("2d");
            window.glycemiaChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: "Glycémie (g/L)",
                            data: values,
                            borderColor: "blue",
                            backgroundColor: "rgba(0, 0, 255, 0.1)",
                            fill: false,
                            tension: 0.4,
                            pointStyle: "circle",
                            pointRadius: 5,
                        },
                        {
                            label: "Valeur seuil min",
                            data: thresholdMin,
                            borderColor: "orange",
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                        },
                        {
                            label: "Valeur seuil max",
                            data: thresholdMax,
                            borderColor: "red",
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: "top" },
                        title: {
                            display: true,
                            text: 'Courbe de Glycémie'
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: false,
                            min: 0,
                            max: 3.5,
                            title: {
                                display: true,
                                text: 'Glycémie (g/L)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Heure'
                            }
                        }
                    },
                },
            });
            
            console.log("Graphique généré avec succès");
        }
        
        // Pré-remplir avec un exemple pour faciliter les tests
        window.onload = function() {
            document.getElementById("data-input").value = 
`8h : 2,95 g/L
9h : 2,91 g/L
10h : 1,67 g/L
11h : 1,4 g/L
12h : 1,17 g/L
13h : 0,78 g/L
14h : 0,8 g/L
15h : 2,33 g/L
16h : 2,05 g/L
17h : 2,21 g/L
18h : 2,37 g/L
19h : 2,74 g/L
20h : 2,87 g/L`;
        };
    </script>
</body>
</html>
